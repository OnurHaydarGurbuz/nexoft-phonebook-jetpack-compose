package com.example.nexoft.feature.contacts

import android.content.Context
import android.content.pm.PackageManager
import android.provider.ContactsContract
import android.util.Log
import androidx.core.content.ContextCompat
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.example.nexoft.feature.remote.ContactsRepositoryImpl
import com.example.nexoft.feature.remote.ServiceLocator
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.flow.update
import kotlinx.coroutines.launch

data class ContactsState(
    val contacts: List<com.example.nexoft.core.model.Contact> = emptyList(),
    val searchQuery: String = "",
    val isRefreshingBadges: Boolean = false,
    val isLoading: Boolean = false,
    val error: String? = null
)

sealed class ContactsEvent {
    data class OnSearchChanged(val q: String) : ContactsEvent()
    object OnErrorDismissed : ContactsEvent()
}

class ContactsViewModel : ViewModel() {

    // ---- UI state ----
    private val _state = MutableStateFlow(ContactsState())
    val state = _state.asStateFlow()

    // ---- Cihaz rehberi rozeti i√ßin cache ----
    private var cachedDeviceNumbers: Set<String> = emptySet()

    // ---- Backend repo ----
    private val remote by lazy { ContactsRepositoryImpl(ServiceLocator.api) }

    // ---- Log etiketi ----
    private val TAG = "ContactsVM"

    // ---- Uygulama a√ßƒ±lƒ±≈üƒ±nda: sadece GET ----
    init {
        fetchAllFromBackend()

        // üîß Test fonksiyonlarƒ± - geli≈ütirme sƒ±rasƒ±nda gerekirse a√ßƒ±n:
        // seedOnceAndRefetch()
        // smokeTestBackend()
    }

    // region --------- BACKEND OPERASYONLARI ---------

    /** Backend: GetAll ‚Üí UI state g√ºncelle ‚Üí Logcat */
    private fun fetchAllFromBackend() {
        viewModelScope.launch {
            _state.update { it.copy(isLoading = true, error = null) }

            runCatching { remote.getAll() }
                .onSuccess { list ->
                    _state.update {
                        it.copy(
                            contacts = list,
                            isLoading = false,
                            error = null
                        )
                    }
                    Log.d(TAG, "GET /GetAll ba≈üarƒ±lƒ±, toplam kayƒ±t=${list.size}")
                }
                .onFailure { e ->
                    _state.update {
                        it.copy(
                            isLoading = false,
                            error = "Veri y√ºklenemedi: ${e.message}"
                        )
                    }
                    Log.e(TAG, "GET /GetAll ba≈üarƒ±sƒ±z: ${e.message}", e)
                }
        }
    }

    /** Manuel refresh fonksiyonu - kullanƒ±cƒ± √ßekip yenilediƒüinde */
    fun refreshContacts() {
        fetchAllFromBackend()
    }

    /** Backend'e ki≈üi ekleme + UI g√ºncelleme */
    fun addContact(first: String, last: String, phone: String, photoUri: String?) {
        viewModelScope.launch {
            _state.update { it.copy(isLoading = true, error = null) }

            try {
                val newContact = com.example.nexoft.core.model.Contact(
                    id = "",
                    firstName = first,
                    lastName = last,
                    phone = phone,
                    photoUrl = photoUri,
                    isInDevice = cachedDeviceNumbers.contains(normalizePhone(phone))
                )

                // Backend'e g√∂nder
                val created = remote.create(newContact, photoFile = null)
                Log.d(TAG, "Ki≈üi eklendi, id=${created.id}")

                // UI state'i g√ºncelle - backend'den d√∂nen veriyi kullan
                _state.update {
                    it.copy(
                        contacts = it.contacts + created,
                        isLoading = false,
                        error = null
                    )
                }

            } catch (e: Exception) {
                _state.update {
                    it.copy(
                        isLoading = false,
                        error = "Ki≈üi eklenemedi: ${e.message}"
                    )
                }
                Log.e(TAG, "Ki≈üi ekleme hatasƒ±: ${e.message}", e)
            }
        }
    }

    /** Backend'e ki≈üi g√ºncelleme + UI g√ºncelleme */
    fun updateContact(
        id: String,
        first: String,
        last: String,
        phone: String,
        photoUri: String?
    ) {
        viewModelScope.launch {
            _state.update { it.copy(isLoading = true, error = null) }

            try {
                val updatedContact = com.example.nexoft.core.model.Contact(
                    id = id,
                    firstName = first,
                    lastName = last,
                    phone = phone,
                    photoUrl = photoUri,
                    isInDevice = cachedDeviceNumbers.contains(normalizePhone(phone))
                )

                // Backend'e g√∂nder
                val updated = remote.update(updatedContact, photoFile = null)
                Log.d(TAG, "Ki≈üi g√ºncellendi, id=${updated.id}")

                // UI state'i g√ºncelle
                _state.update { s ->
                    s.copy(
                        contacts = s.contacts.map { c ->
                            if (c.id == id) updated else c
                        },
                        isLoading = false,
                        error = null
                    )
                }

            } catch (e: Exception) {
                _state.update {
                    it.copy(
                        isLoading = false,
                        error = "Ki≈üi g√ºncellenemedi: ${e.message}"
                    )
                }
                Log.e(TAG, "Ki≈üi g√ºncelleme hatasƒ±: ${e.message}", e)
            }
        }
    }

    /** Backend'den ki≈üi silme + UI g√ºncelleme */
    fun deleteContact(id: String) {
        viewModelScope.launch {
            _state.update { it.copy(isLoading = true, error = null) }

            try {
                // Backend'den sil
                remote.delete(id)
                Log.d(TAG, "Ki≈üi silindi, id=$id")

                // UI state'ten √ßƒ±kar
                _state.update { s ->
                    s.copy(
                        contacts = s.contacts.filterNot { it.id == id },
                        isLoading = false,
                        error = null
                    )
                }

            } catch (e: Exception) {
                _state.update {
                    it.copy(
                        isLoading = false,
                        error = "Ki≈üi silinemedi: ${e.message}"
                    )
                }
                Log.e(TAG, "Ki≈üi silme hatasƒ±: ${e.message}", e)
            }
        }
    }

    // endregion --------- BACKEND OPERASYONLARI ---------

    // region --------- TEST FONKSƒ∞YONLARI (ƒ∞STEƒûE BAƒûLI) ---------

    /** (ƒ∞STEƒûE BAƒûLI) Tek seferlik tohumlama: 1 kayƒ±t ekle ‚Üí tekrar GET */
    private var seededOnce = false
    private fun seedOnceAndRefetch() {
        if (seededOnce) return
        seededOnce = true

        viewModelScope.launch {
            try {
                val yeni = com.example.nexoft.core.model.Contact(
                    id = "",
                    firstName = "Test",
                    lastName = "User",
                    phone = "5550001122",
                    photoUrl = null,
                    isInDevice = false
                )
                val created = remote.create(yeni, photoFile = null)
                Log.d(TAG, "SEED: Ki≈üi olu≈üturuldu, id=${created.id}")

                fetchAllFromBackend()
            } catch (e: Exception) {
                Log.e(TAG, "SEED: Ki≈üi olu≈üturma hatasƒ±: ${e.message}", e)
            }
        }
    }

    /**
     * (ƒ∞STEƒûE BAƒûLI) Tam duman testi:
     * GET ‚Üí CREATE (fake) ‚Üí UPDATE (telefonuna '9' ekle) ‚Üí DELETE ‚Üí GET
     */
    private fun smokeTestBackend() {
        viewModelScope.launch {
            try {
                val before = remote.getAll()
                Log.d(TAG, "DMN: ƒ∞lk GET tamam, mevcut kayƒ±t sayƒ±sƒ±=${before.size}")

                val tmp = com.example.nexoft.core.model.Contact(
                    id = "",
                    firstName = "Test",
                    lastName = "User",
                    phone = "5550001122",
                    photoUrl = null,
                    isInDevice = false
                )
                val created = remote.create(tmp, photoFile = null)
                Log.d(TAG, "DMN: CREATE ba≈üarƒ±lƒ±, id=${created.id}")

                val updatedReq = created.copy(phone = created.phone + "9")
                val updated = remote.update(updatedReq, photoFile = null)
                Log.d(TAG, "DMN: UPDATE ba≈üarƒ±lƒ±, id=${updated.id}, yeniTelefon=${updated.phone}")

                remote.delete(updated.id)
                Log.d(TAG, "DMN: DELETE ba≈üarƒ±lƒ±, silinen id=${updated.id}")

                val after = remote.getAll()
                Log.d(TAG, "DMN: Son GET tamam, g√ºncel kayƒ±t sayƒ±sƒ±=${after.size}")
            } catch (e: Exception) {
                Log.e(TAG, "DMN: Duman testi ba≈üarƒ±sƒ±z: ${e.message}", e)
            }
        }
    }

    // endregion --------- TEST FONKSƒ∞YONLARI ---------

    // region --------- UI EVENT HANDLƒ∞NG ---------

    fun onEvent(event: ContactsEvent) {
        when (event) {
            is ContactsEvent.OnSearchChanged ->
                _state.update { it.copy(searchQuery = event.q) }
            is ContactsEvent.OnErrorDismissed ->
                _state.update { it.copy(error = null) }
        }
    }

    /** (Lokal) Cihazda kayƒ±tlƒ± rozetini i≈üaretlemek */
    fun markAsSavedToDevice(contactId: String) {
        _state.update { s ->
            val target = s.contacts.firstOrNull { it.id == contactId }
            if (target != null) {
                cachedDeviceNumbers = cachedDeviceNumbers + normalizePhone(target.phone)
            }
            s.copy(
                contacts = s.contacts.map { c ->
                    if (c.id == contactId) c.copy(isInDevice = true) else c
                }
            )
        }
    }

    /** (Lokal) Cihaz rehberini okuyup rozetleri g√ºncellemek */
    fun refreshDeviceBadges(ctx: Context) {
        if (!hasReadContacts(ctx)) return
        _state.update { it.copy(isRefreshingBadges = true) }

        viewModelScope.launch(Dispatchers.IO) {
            val numbers = readAllDeviceNumbers(ctx).map(::normalizePhone).toSet()
            cachedDeviceNumbers = numbers

            _state.update { s ->
                val updated = s.contacts.map { c ->
                    val inDevice = numbers.contains(normalizePhone(c.phone))
                    if (c.isInDevice != inDevice) c.copy(isInDevice = inDevice) else c
                }
                s.copy(contacts = updated, isRefreshingBadges = false)
            }
        }
    }

    // endregion --------- UI EVENT HANDLƒ∞NG ---------

    // region --------- Yardƒ±mcƒ±lar ---------

    private fun hasReadContacts(ctx: Context): Boolean =
        ContextCompat.checkSelfPermission(
            ctx, android.Manifest.permission.READ_CONTACTS
        ) == PackageManager.PERMISSION_GRANTED

    /** Cihaz rehberinden t√ºm telefon numaralarƒ±nƒ± (string) √ßeker. */
    private fun readAllDeviceNumbers(ctx: Context): List<String> {
        val cr = ctx.contentResolver
        val list = mutableListOf<String>()
        val uri = ContactsContract.CommonDataKinds.Phone.CONTENT_URI
        val numCol = ContactsContract.CommonDataKinds.Phone.NUMBER
        try {
            cr.query(uri, arrayOf(numCol), null, null, null)?.use { cur ->
                val idx = cur.getColumnIndexOrThrow(numCol)
                while (cur.moveToNext()) {
                    list += (cur.getString(idx) ?: "")
                }
            }
        } catch (_: SecurityException) {
            // izin yoksa sessiz
        } catch (_: Throwable) {
            // diƒüer hatalar sessiz
        }
        return list
    }

    /** Basit normalize: sadece rakamlarƒ± bƒ±rak. */
    private fun normalizePhone(raw: String): String = raw.filter { it.isDigit() }

    // endregion --------- Yardƒ±mcƒ±lar ---------
}